<!DOCTYPE html>
<html>
<head>
	<title>ToDoIt Settings</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="https://bootswatch.com/paper/bootstrap.min.css">
	<style type="text/css">
		.bar {
			background-color: #2196f3; 
			color: white; 
			height: 50px; 
			width: 100%;
			position: fixed;
			top: 0;
			left: 0;
			z-index: 400;
		}

		.back {
			display: inline-block;
			height: 50px;
			width: 50px;
			text-align: center;
			padding-top: 10px;
		}

		.back:hover, .back:focus, .back:active {
			background-color: #0c7cd5;
		}

		.back img {
			max-height: 30px;
		}

		.title {
			display: inline-block;
			position: relative;
			top: 5px;
			margin: 0;
			margin-left: 10px;
			color: white;
		}

		.main {
			padding-top: 70px;
		}
	</style>
</head>
<body>
	<div class="bar">
		<a class="back" href="pebblejs://close#">
			<img src="back.png" />
		</a>
		<h4 class="title">ToDoIt Settings</h4>
	</div>
	<div class="container-fluid main">
		<form>
			<legend>Tasks</legend>
			<div id="Tasks">
				<div class="form-group">
					<input class="form-control" name="task" type="text" placeholder="My New Task" />
				</div>
			</div>
			<div class="form-group">
				<button type="button" id="addTask" class="btn btn-info">+ Add Another Task</button>
			</div>
			<legend>Reminders</legend>
			<div id="Reminders">
				
			</div>
			<div class="form-group">
				<button type="button" id="addReminder" class="btn btn-info">+ Add Another Reminder</button>
			</div>
			<div class="form-group text-center">
				<button class="btn btn-primary btn-lg" style="width: 100%;" type="submit">Save</button>
			</div>
		</form>
	</div>
	<script type="text/javascript">
		function getQueryParam(variable, default_) {
		    var query = location.search.substring(1);
		    var vars = query.split('&');
		    for (var i = 0; i < vars.length; i++) {
		        var pair = vars[i].split('=');
		        if (pair[0] == variable)
		            return decodeURIComponent(pair[1]);
		    }
		    return default_ || false;
		}

		var return_to = getQueryParam('return_to', 'pebblejs://close#');

		var hourToAMPM = function(h) {
			if(h < 0) return null;
			else if(h == 0) return {v: 12, t: 'am'};
			else if(h < 12) return {v: h, t: 'am'};
			else if(h == 12) return {v: 12, t: 'pm'};
			else if(h > 12) return {v: h-12, t: 'pm'};
			else if(h > 23) return null;
		}

		var AMPMToHour= function(el) {
			if(el.querySelector('input[name="reminder"]').value < 1 || el.querySelector('input[name="reminder"]').value > 12) {
				//invalid
				return -1;
			} else {
				if(el.querySelector('select[name="reminderTime"]').value == "am") {
					if(el.querySelector('input[name="reminder"]').value == 12) return 0;
					else return parseInt(el.querySelector('input[name="reminder"]').value);
				} else {
					if(el.querySelector('input[name="reminder"]').value == 12) return 12;
					else return parseInt(el.querySelector('input[name="reminder"]').value) + 12;
				}
			}
		}

		var hasError = function(el) {
			el.className = el.className + ' has-error';
			el.querySelector('.help-block').style.display = "block";
		}

		var setTimeField = function(field, value) {
			if(!value && value != 0) {
				if(field == "morning") {
					document.getElementById(field).value = 11;
					document.getElementById(field+"Time").value = 'am';
				} else if(field == "evening") {
					document.getElementById(field).value = 7;
					document.getElementById(field+"Time").value = 'pm';
				} else if(field == "night") {
					document.getElementById(field).value = 10;
					document.getElementById(field+"Time").value = 'pm';
				}
			} else if(value < 0) {
				document.getElementById(field).disabled = true;
				document.getElementById(field+"Time").disabled = true;
				document.getElementById(field+"Disabled").checked = true;
			} else if(value < 24) {
				var time = hourToAMPM(value);
				document.getElementById(field).value = time.v;
				document.getElementById(field+"Time").value = time.t;
			}
		}

		var updateValues = function() {
			var query = "";
			if(location.search.split("#")[1]) query = decodeURIComponent(location.search.split("#")[1]);
			if(query.length>1) {
				query = JSON.parse(query);
				var reminders = query.reminders;
				console.log(query);
				reminders.sort(function(a, b) {
					return a - b;
				});
				for (var i = 0; i < reminders.length; i++) {
					newReminder(reminders[i]);
				}
			}
		}

		var setOnClickEvents = function() {
			var remindersBtn = document.getElementById('Reminders').querySelectorAll('.form-group .removeReminder');
			for (var i = 0; i < remindersBtn.length; i++) {
				remindersBtn[i].onclick = function(e) {
					e.preventDefault();
					remNode = e.target.parentNode.parentNode.parentNode;
					remNode.parentNode.removeChild(remNode);
				}
			};
		}

		var newReminder = function(time) {
			var ampm = null;
			if(time>=0) ampm = hourToAMPM(time);
			var div = document.createElement("div");
			div.className = 'form-group';
			div.innerHTML = '<div class="row"> \
						<div class="col-xs-6"> \
							<input class="form-control" name="reminder"'+(ampm ? ' value="'+ampm.v+'"' : '')+' type="number" placeholder="10" /> \
						</div> \
						<div class="col-xs-4"> \
							<select class="form-control" name="reminderTime"> \
								<option value="pm"'+(ampm ? (ampm.t=="pm" ? ' selected' : '') : '')+'>PM</option> \
								<option value="am"'+(ampm ? (ampm.t=="am" ? ' selected' : '') : '')+'>AM</option> \
							</select> \
						</div> \
						<div class="col-xs-2"> \
							<button type="button" class="removeReminder btn btn-danger pull-right">X</button> \
						</div> \
					</div> \
					<span style="display: none;" class="help-block">Have to be a valid hour in 1-12 AM/PM format</span>';
			document.getElementById('Reminders').appendChild(div);
			setOnClickEvents();
		}


		document.getElementById("addTask").onclick = function(e) {
			e.preventDefault();
			var div = document.createElement("div");
			div.className = 'form-group';
			div.innerHTML = '<input class="form-control" name="task" type="text" placeholder="My New Task" />';
			document.getElementById('Tasks').appendChild(div);
		}		

		document.getElementById("addReminder").onclick = function(e) {
			e.preventDefault();
			newReminder();
		}


		

		window.onsubmit = function(e) {
			e.preventDefault();
			var err = false;
			var tasks = document.getElementById('Tasks').querySelectorAll('.form-group input');
			var newTasks = [];
			for (var i = 0; i < tasks.length; i++) {
				if(tasks[i].value) newTasks.push(tasks[i].value);
			};
			var reminders = document.getElementById('Reminders').querySelectorAll('.form-group');
			var newReminders = [];
			for (var i = 0; i < reminders.length; i++) {
				if(AMPMToHour(reminders[i]) >= 0) newReminders.push(AMPMToHour(reminders[i]));
				else {
					hasError(reminders[i]);
					err = true;
				}
			};
			var options = {
				reminders: newReminders,
				tasks: newTasks
			}
			if(!err) {
				document.location = return_to + encodeURIComponent(JSON.stringify(options));
			}
		};

		updateValues();
	</script>
</body>
</html>