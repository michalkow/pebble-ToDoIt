<!DOCTYPE html>
<html>
<head>
	<title>ToDoIt Settings</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="https://bootswatch.com/paper/bootstrap.min.css">
	<style type="text/css">
		.bar {
			background-color: #2196f3; 
			color: white; 
			height: 50px; 
			width: 100%;
			margin-bottom: 20px;
		}

		.back {
			display: inline-block;
			height: 50px;
			width: 50px;
			text-align: center;
			padding-top: 10px;
		}

		.back:hover, .back:focus, .back:active {
			background-color: #0c7cd5;
		}

		.back img {
			max-height: 30px;
		}

		.title {
			display: inline-block;
			position: relative;
			top: 5px;
			margin: 0;
			margin-left: 10px;
			color: white;
		}

		input[disabled] {
			color: #ddd;
		}

		select[disabled] {
			color: #ddd;
			box-shadow: none;
			border-bottom: 1px dotted #ddd;
		}
	</style>
</head>
<body>
	<div class="bar">
		<a class="back" href="pebblejs://close#">
			<img src="back.png" />
		</a>
		<h4 class="title">ToDoIt Settings</h4>
	</div>
	<div class="container-fluid">
		<form>
			<div class="form-group" id="morningGroup">
				<label class="control-label" for="morning">Morning</label>
				<div class="row">
					<div class="col-xs-8">
						<input class="form-control" name="morning" id="morning" type="number" />
					</div>
					<div class="col-xs-4">
						<select class="form-control" name="morningTime" id="morningTime">
							<option value="pm">PM</option>
							<option value="am" selected>AM</option>
						</select>
					</div>
				</div>
				<span style="display: none;" class="help-block">Have to be a valid hour in 1-12 AM/PM format</span>
				<div class="checkbox">
          <label>
            <input name="morningDisabled" id="morningDisabled" type="checkbox" /> Disable morning reminder
          </label>
        </div>
			</div>
			<div class="form-group" id="eveningGroup">
				<label class="control-label" for="evening">Evening</label>
				<div class="row">
					<div class="col-xs-8">
						<input class="form-control" name="evening" id="evening" type="number" />
					</div>
					<div class="col-xs-4">
						<select class="form-control" name="eveningTime" id="eveningTime">
							<option value="pm" selected>PM</option>
							<option value="am">AM</option>
						</select>
					</div>
				</div>
				<span style="display: none;" class="help-block">Have to be a valid hour in 1-12 AM/PM format</span>
				<div class="checkbox">
          <label>
            <input name="eveningDisabled" id="eveningDisabled" type="checkbox" /> Disable evening reminder
          </label>
        </div>
			</div>
			<div class="form-group" id="nightGroup">
				<label class="control-label" for="night">Night</label>
				<div class="row">
					<div class="col-xs-8">
						<input class="form-control" name="night" id="night" type="number" />
					</div>
					<div class="col-xs-4">
						<select class="form-control" name="nightTime" id="nightTime">
							<option value="pm" selected>PM</option>
							<option value="am">AM</option>
						</select>
					</div>
				</div>
				<span style="display: none;" class="help-block">Have to be a valid hour in 1-12 AM/PM format</span>
				<div class="checkbox">
          <label>
            <input name="nightDisabled" id="nightDisabled" type="checkbox" /> Disable night reminder
          </label>
        </div>
			</div>
			<div class="form-group text-center">
				<button class="btn btn-primary btn-lg" style="width: 100%;" type="submit">Save</button>
			</div>
		</form>
	</div>
	<script type="text/javascript">
		var fieldNames = ['morning', 'evening', 'night'];

		var QueryString = function () {
		  // This function is anonymous, is executed immediately and 
		  // the return value is assigned to QueryString!
		  var query_string = {};
		  var query = window.location.search.substring(1);
		  var vars = query.split("&");
		  for (var i=0;i<vars.length;i++) {
		    var pair = vars[i].split("=");
		        // If first entry with this name
		    if (typeof query_string[pair[0]] === "undefined") {
		      query_string[pair[0]] = decodeURIComponent(pair[1]);
		        // If second entry with this name
		    } else if (typeof query_string[pair[0]] === "string") {
		      var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
		      query_string[pair[0]] = arr;
		        // If third or later entry with this name
		    } else {
		      query_string[pair[0]].push(decodeURIComponent(pair[1]));
		    }
		  } 
		  return query_string;
		};

		var hourToAMPM = function(h) {
			if(h < 0) return null;
			else if(h == 0) return {v: 12, t: 'am'};
			else if(h < 12) return {v: h, t: 'am'};
			else if(h == 12) return {v: 12, t: 'pm'};
			else if(h > 12) return {v: h-12, t: 'pm'};
			else if(h > 23) return null;
		}

		var AMPMToHour= function(field) {
			if(document.getElementById(field+"Disabled").checked) {
				return -2;
			} else if(document.getElementById(field).value < 1 || document.getElementById(field).value > 12) {
				//invalid
				return -1;
			} else {
				if(document.getElementById(field+"Time").value == "am") {
					if(document.getElementById(field).value == 12) return 0;
					else return document.getElementById(field).value;
				} else {
					return parseInt(document.getElementById(field).value) + 12;
				}
			}
		}

		var hasError = function(group) {
			document.getElementById(group+'Group').className = document.getElementById(group+'Group').className + ' has-error';
			document.getElementById(group+'Group').querySelector('.help-block').style.display = "block";
		}

		var setTimeField = function(field, value) {
			if(!value && value != 0) {
				if(field == "morning") {
					document.getElementById(field).value = 11;
					document.getElementById(field+"Time").value = 'am';
				} else if(field == "evening") {
					document.getElementById(field).value = 7;
					document.getElementById(field+"Time").value = 'pm';
				} else if(field == "night") {
					document.getElementById(field).value = 10;
					document.getElementById(field+"Time").value = 'pm';
				}
			} else if(value < 0) {
				document.getElementById(field).disabled = true;
				document.getElementById(field+"Time").disabled = true;
				document.getElementById(field+"Disabled").checked = true;
			} else if(value < 24) {
				var time = hourToAMPM(value);
				document.getElementById(field).value = time.v;
				document.getElementById(field+"Time").value = time.t;
			}
		}

		var updateValues = function() {
			var query = QueryString();
			for (var i = 0; i < fieldNames.length; i++) {
				setTimeField(fieldNames[i], query[fieldNames[i]]);
			};
		}

		window.onsubmit = function(e) {
			e.preventDefault();
			var err = false;
			var options = {
				morning: AMPMToHour('morning'),
				evening: AMPMToHour('evening'),
				night: AMPMToHour('night')
			}
			for (name in options) {
				if(options[name] == -1) {
					hasError(name);
					err = true;
				}
			};
			if(!err) {
				document.location.search = '?morning=' + options.morning + "&evening=" + options.evening + "&night=" + options.night;
				document.location = 'pebblejs://close#' + encodeURIComponent(JSON.stringify(options));
			}
		};

		for (var i = 0; i < fieldNames.length; i++) {
			var checked = function (fieldName) {
				document.getElementById(fieldName+"Disabled").onchange = function(e) {
					if(e.target.checked) {
						document.getElementById(fieldName).disabled = true;
						document.getElementById(fieldName+"Time").disabled = true;
					} else {
						document.getElementById(fieldName).disabled = false;
						document.getElementById(fieldName+"Time").disabled = false;
					};
				}
			};
			checked(fieldNames[i]);
		};


		updateValues();
	</script>
</body>
</html>